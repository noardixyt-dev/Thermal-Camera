<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>Mobile Camera + Thermal Overlay (GitHub Pages Safe)</title>
  <style>
    html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui}
    #wrap{position:fixed;inset:0;display:flex;flex-direction:column;padding:8px;gap:8px}
    #viewer{flex:1;position:relative;overflow:hidden;border-radius:12px;background:#111}
    video{display:none}
    canvas{width:100%;height:100%;object-fit:cover}
    select,input,button{font-size:14px;padding:6px;border-radius:6px;border:0}
    button{background:#0af;color:#000}
    .controls{display:flex;flex-wrap:wrap;gap:8px}
  </style>
</head>
<body>
<div id="wrap">
  <div id="viewer">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
  </div>

  <div class="controls">
    <select id="mode">
      <option value="luminance">Thermal from Luminance</option>
      <option value="none">No Overlay</option>
    </select>
    <input id="intensity" type="range" min="0" max="1" step="0.01" value="0.7">
    <button id="flip">Flip</button>
    <button id="snap">Snapshot</button>
  </div>
</div>

<script>
(async()=>{
  const video=document.querySelector('#video');
  const canvas=document.querySelector('#canvas');
  const ctx=canvas.getContext('2d');
  const mode=document.querySelector('#mode');
  const intensity=document.querySelector('#intensity');
  const flipBtn=document.querySelector('#flip');
  const snapBtn=document.querySelector('#snap');
  let flipped=false;

  function resize(){
    if(video.videoWidth){
      canvas.width=video.videoWidth;
      canvas.height=video.videoHeight;
    }
  }
  window.addEventListener('resize',resize);

  // GitHub Pages SAFE camera request
  async function startCamera(){
    const constraints={ video:{ facingMode:"environment" } };
    try{
      const stream=await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject=stream;
      await video.play();
      resize();
    }catch(e){
      alert("Camera error: "+e.message);
    }
  }

  snapBtn.onclick=()=>{
    const a=document.createElement('a');
    a.download='thermal.png';
    a.href=canvas.toDataURL();
    a.click();
  };
  flipBtn.onclick=()=> flipped=!flipped;

  function thermalColor(v){
    const a=[0,0,100],b=[255,80,0];
    return [a[0]+(b[0]-a[0])*v,a[1]+(b[1]-a[1])*v,a[2]+(b[2]-a[2])*v];
  }

  function loop(){
    if(video.readyState>=2){
      resize();
      ctx.save();
      if(flipped){ctx.translate(canvas.width,0);ctx.scale(-1,1);}    
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      ctx.restore();

      if(mode.value!=='none'){
        const frame=ctx.getImageData(0,0,canvas.width,canvas.height);
        const d=frame.data;    
        for(let i=0;i<d.length;i+=4){
          const l=(d[i]*0.2126+d[i+1]*0.7152+d[i+2]*0.0722)/255;
          const [r,g,b]=thermalColor(l);
          const a=parseFloat(intensity.value);
          d[i]=d[i]*(1-a)+r*a;
          d[i+1]=d[i+1]*(1-a)+g*a;
          d[i+2]=d[i+2]*(1-a)+b*a;
        }
        ctx.putImageData(frame,0,0);
      }
    }
    requestAnimationFrame(loop);
  }

  await startCamera();
  loop();
})();
</script>
</body>
</html>
